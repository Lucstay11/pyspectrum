<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Spectrum Analyser</title>

        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">

    </head>

    <body>
        <p>Hello</p>

        <script>
            async function onMessageArrived(binary_blob_data) {
                let buffer = await binary_blob_data.arrayBuffer();
                let length = buffer.byteLength;

                let uint = new Uint8Array(buffer);
                let dataView = new DataView(uint.buffer);

                // data is network order, i.e. big endian

                // 5 integers
                let sps = dataView.getInt32((0), false);
                let cf = dataView.getInt32((4), false);
                let time_start = dataView.getInt32((8), false);
                let time_end = dataView.getInt32((12), false);
                let num_floats = dataView.getInt32((16), false);
                console.log(sps+" "+cf+" "+time_start+" "+time_end+" "+num_floats);

                // floats
                let start_index=20 // after 5 4 byte integers
                let spectrum = new Float32Array(num_floats);
                for (var i=0; i<num_floats; i++){
                    spectrum[i]=dataView.getFloat32((start_index+4*i), false);
                }
                start_index = start_index+num_floats*4;
                let peaks = new Float32Array(num_floats);
                for (var i=0; i<num_floats; i++){
                    peaks[i]=dataView.getFloat32((start_index+4*i), false);
                }
            };

            var ws = new WebSocket("ws://127.0.0.1:5555/"), messages = document.createElement('ul');

            ws.onmessage = function (event) {
                onMessageArrived(event.data)

                var messages = document.getElementsByTagName('ul')[0],
                    message = document.createElement('li'),
                    content = document.createTextNode(event.data);
                message.appendChild(content);
                messages.appendChild(message);
            };
            document.body.appendChild(messages);
        </script>

    </body>
</html>
